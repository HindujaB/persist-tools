/*
 *  Copyright (c) 2024 WSO2 LLC. (http://www.wso2.com).
 *
 *  WSO2 Inc. licenses this file to you under the Apache License,
 *  Version 2.0 (the "License"); you may not use this file except
 *  in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing,
 *  software distributed under the License is distributed on an
 *  "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 *  KIND, either express or implied.  See the License for the
 *  specific language governing permissions and limitations
 *  under the License.
 */
package io.ballerina.persist.models;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;

/**
 * Class to process and store migrate differences.
 *
 *
 */
public class MigrationDataHolder {

    private final List<String> addedEntities = new ArrayList<>();
    private final List<NameMapping> renamedEntities = new ArrayList<>();
    private final List<String> removedEntities = new ArrayList<>();
    private final Map<String, List<EntityField>> addedFields = new HashMap<>();
    private final Map<String, List<NameMapping>> renamedFields = new HashMap<>();
    private final Map<String, List<String>> removedFields = new HashMap<>();
    private final Map<String, List<EntityField>> changedFieldTypes = new HashMap<>();
    private final Set<String> primaryKeyChangedEntities = new HashSet<>();
    private final Map<String, List<ForeignKey>> addedForeignKeys = new HashMap<>();
    private final Map<String, List<ForeignKey>> removedForeignKeys = new HashMap<>();
    private final List<String> differences = new ArrayList<>();
    private final Map<String, List<Index>> addedIndexes = new HashMap<>();
    private final Map<String, List<Index>> removedIndexes = new HashMap<>();
    public record NameMapping(String oldName, String newName) { }

    public void addTable(String tableName) {
        differences.add("Table " + tableName + " has been added");
        addedEntities.add(tableName);
    }

    public void removeTable(String tableName) {
        differences.add("Table " + tableName + " has been removed");
        removedEntities.add(tableName);
    }

    public void renameTable(String oldName, String newName) {
        differences.add("Table " + oldName + " has been renamed to " + newName);
        renamedEntities.add(new NameMapping(oldName, newName));
    }

    public void changePrimaryKey(String tableName) {
        differences.add("Primary key of table " + tableName + " has changed");
        primaryKeyChangedEntities.add(tableName);
    }

    public void addColumn(String tableName, EntityField field, boolean isPrimary) {
        differences.add("Column " + field.getFieldColumnName() + " of type " +
                field.getFieldType() + " has been added to table " +
                tableName + (isPrimary ? " as a primary key" : ""));
        if (isPrimary) {
            primaryKeyChangedEntities.add(tableName);
        }
        addOrModifyColumn(tableName, field, addedFields);
    }

    public void modifyColumn(String tableName, EntityField previousModelField, EntityField currentModelField) {
        differences.add("Data type of column " + previousModelField.getFieldColumnName() +
                " in table " + tableName + " has changed to " +
                (currentModelField.isOptionalType() ? "optional " : "required ") + currentModelField.getFieldType() +
                (currentModelField.getSqlType() != null ? " with SQL type " +
                        currentModelField.getSqlType().getTypeName() : "") +
                (currentModelField.isDbGenerated() ? " and will be generated by the database" : ""));
        addOrModifyColumn(tableName, currentModelField, changedFieldTypes);
    }

    private void addOrModifyColumn(String tableName, EntityField field, Map<String, List<EntityField>> fieldMap) {
        if (!fieldMap.containsKey(tableName)) {
            List<EntityField> initialData = new ArrayList<>();
            initialData.add(field);
            fieldMap.put(tableName, initialData);
        } else {
            List<EntityField> existingData = fieldMap.get(tableName);
            existingData.add(field);
            fieldMap.put(tableName, existingData);
        }
    }

    public void removeColumn(String tableName, String columnName) {
        differences.add("Column " + columnName + " has been removed from table " + tableName);
        if (!removedFields.containsKey(tableName)) {
            List<String> initialData = new ArrayList<>();
            initialData.add(columnName);
            removedFields.put(tableName, initialData);
        } else {
            List<String> existingData = removedFields.get(tableName);
            existingData.add(columnName);
            removedFields.put(tableName, existingData);
        }
    }

    public void recreateForeignKey(String tableName, EntityField previousModelField, EntityField currentModelField) {
        differences.add("Relation " + previousModelField.getFieldColumnName() +
                " in table " + tableName + " has changed");
        removeForeignKey(tableName, previousModelField);
        createForeignKeys(tableName, currentModelField);
    }

    public void removeForeignKey(String tableName, EntityField field) {
        differences.add("Relation " + field.getFieldColumnName() + " has been removed from table " + tableName);
        addOrRemoveForeignKey(tableName, field, removedForeignKeys);
    }

    public void renameColumn(String tableName, String oldName, String newName) {
        differences.add("Column " + oldName + " in table " + tableName + " has been renamed to " + newName);
        if (!renamedFields.containsKey(tableName)) {
            List<NameMapping> initialData = new ArrayList<>();
            initialData.add(new NameMapping(oldName, newName));
            renamedFields.put(tableName, initialData);
        } else {
            List<NameMapping> existingData = renamedFields.get(tableName);
            existingData.add(new NameMapping(oldName, newName));
            renamedFields.put(tableName, existingData);
        }
    }

    private void addOrRemoveForeignKey(String tableName, EntityField field, Map<String, List<ForeignKey>> map) {
        if (field.getRelation() == null) {
            return;
        }
        String removeKeyName = String.format("FK_%s_%s", tableName,
                field.getRelation().getAssocEntity().getTableName());
        ForeignKey foreignKey = new ForeignKey(removeKeyName,
                field.getRelation().getKeyColumns().stream().map(Relation.Key::getColumnName).toList(),
                field.getRelation().getAssocEntity().getTableName(),
                field.getRelation().getKeyColumns().stream().map(Relation.Key::getReferenceColumnName).toList());

        if (!map.containsKey(tableName)) {
            List<ForeignKey> initialData = new ArrayList<>();
            initialData.add(foreignKey);
            map.put(tableName, initialData);
        } else {
            List<ForeignKey> existingData = map.get(tableName);
            existingData.add(foreignKey);
            map.put(tableName, existingData);
        }
    }

    public void removeIndex(String tableName, Index index) {
        differences.add("Index " + index.getIndexName() + " has been removed from table " + tableName);
        addOrRemoveIndex(tableName, index, removedIndexes);
    }

    public void addIndex(String tableName, Index index) {
        differences.add("Index " + index.getIndexName() + " on column(s) " + index.getFields().stream()
                .map(EntityField::getFieldColumnName).reduce((a, b) -> a + ", " + b).orElse("") +
                " has been added to table " + tableName);
        addOrRemoveIndex(tableName, index, addedIndexes);
    }

    private void addOrRemoveIndex(String tableName, Index index, Map<String, List<Index>> map) {
        if (!map.containsKey(tableName)) {
            List<Index> initialData = new ArrayList<>();
            initialData.add(index);
            map.put(tableName, initialData);
        } else {
            List<Index> existingData = map.get(tableName);
            existingData.add(index);
            map.put(tableName, existingData);
        }
    }

    public void createForeignKeys(String tableName, EntityField currentModelField) {

        for (Relation.Key key : currentModelField.getRelation().getKeyColumns()) {
            differences.add("Column " + key.getColumnName() + " of type " + key.getType() +
                    " has been added to table " + tableName
                    + " as a foreign key");
        }

        createForeignKeyColumn(tableName, currentModelField);

        differences.add("Relation " + currentModelField.getFieldName() + " of type " +
                currentModelField.getFieldType() + " has been added to table " +
                tableName);
        addOrRemoveForeignKey(tableName, currentModelField, addedForeignKeys);
    }

    private void createForeignKeyColumn(String tableName, EntityField field) {
        for (Relation.Key key : field.getRelation().getKeyColumns()) {
            EntityField primaryKey = field.getRelation().getAssocEntity()
                    .getFieldByColumnName(key.getReferenceColumnName());
            EntityField.Builder customFkBuilder = EntityField.newBuilder(key.getField());
            customFkBuilder.setFieldColumnName(key.getColumnName());
            customFkBuilder.setType(primaryKey.getFieldType());
            customFkBuilder.setArrayType(false);
            customFkBuilder.setSqlType(primaryKey.getSqlType());

            addOrModifyColumn(tableName, customFkBuilder.build(), addedFields);
        }
    }

    public boolean isEntityRenamed(String tableName) {
        return renamedEntities.stream().anyMatch(entry -> entry.newName().equals(tableName));
    }

    public List<String> getAddedEntities() {
        return addedEntities;
    }

    public List<NameMapping> getRenamedEntities() {
        return renamedEntities;
    }

    public List<String> getRemovedEntities() {
        return removedEntities;
    }

    public Map<String, List<EntityField>> getAddedFields() {
        return addedFields;
    }

    public Map<String, List<NameMapping>> getRenamedFields() {
        return renamedFields;
    }

    public Map<String, List<String>> getRemovedFields() {
        return removedFields;
    }

    public Map<String, List<EntityField>> getChangedFieldTypes() {
        return changedFieldTypes;
    }

    public Set<String> getPrimaryKeyChangedEntities() {
        return primaryKeyChangedEntities;
    }

    public Map<String, List<ForeignKey>> getAddedForeignKeys() {
        return addedForeignKeys;
    }

    public Map<String, List<ForeignKey>> getRemovedForeignKeys() {
        return removedForeignKeys;
    }

    public List<String> getDifferences() {
        return differences;
    }

    public Map<String, List<Index>> getAddedIndexes() {
        return addedIndexes;
    }

    public Map<String, List<Index>> getRemovedIndexes() {
        return removedIndexes;
    }
}
